@using System.Web.UI.WebControls
@model OdeToFood.Data.Models.Restaurant
@{
    ViewBag.Title = "title";
}

<h2 class="text-center" style="margin-top:40px">Tables booking</h2>

<div class="row">
    <div class="col-ld-6 col-md-6" style="background-color: lightseagreen; height: 460px; margin-top: 20px; padding: 5px; border-radius: 10px">
        @foreach (var table in Model.Tables)
        {
            <div class="col-ld-4 col-md-4 text-center">
                <div class="tableBg" style="margin-top: 20px;background: #1c8c86; border-radius:10px"><span data-tableid=@table.Id data-url="@Url.Action("PlaceOrder", "BookTable", new {id = table.Id, restaurantId = TempData["RestaurantId"]})" class="glyph" style="font-size:6em;color:#444">@table.TableNumber</span></div>
            </div>
        }
    </div>
    <div class="col-ld-6 col-md-6 msmqpartial" style="background-color: ghostwhite; height: 460px; margin-top: 20px; padding: 30px; border-radius: 10px; border: 3px solid lightseagreen">
        <h3 class="text-center">Click on the table to book</h3>
    </div>
</div>
<div class="row" style="margin-top: 20px">
    <div id="avialableTableDiv" class="col-md-6 col-lg-6" style="background: ghostwhite; padding: 20px;">
        <h4>Select the time to see avialable tables:</h4>
        <input type="text" id="timeForAvialability" class="form-control" />
        <div id="avialableTableList" style="margin-top:20px"></div>
    </div>
    <div id="freeTimePanel" class="col-md-6 col-lg-6" style="background: ghostwhite; padding: 20px; display: none">
        <h4 style="margin-left:15px">Select the date to see the avialable time for the table:</h4>
        <div class="form-group">
            <input type="text" id="datePicker" class="form-control" style="margin-left: 15px" />
        </div>
        <div id="avialableTimeList" style="margin-left:15px"></div>
    </div>
</div>

@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")

    <script>
        jQuery(document).ready(function() {
            var date = new Date();
            $("#timeForAvialability").val(date.dateFormat("Y/m/d") + " " + date.toTimeString().replace(/.*(\d{2}:\d{2}:\d{2}).*/, "$1"));

            $("#timeForAvialability").datetimepicker();
            $("#datePicker").datetimepicker({ timepicker: false, format: 'd.m.Y' });

            $("#timeForAvialability").blur(function() {
                var model = @Html.Raw(Json.Encode(Model.Id));
                var params = { time: $(this).val(), restaurantId: model };
                $.ajax({
                    url: "@Url.Action("GetAvialableTables", "BookTable")",
                    contentType: "application/json",
                    data: JSON.stringify(params),
                    type: 'POST',
                    cache: false,
                    async: true,
                    success: function(result) {
                        $('#avialableTableList').html(result);
                    }
                });
                return false;
            });

            var tableClickedId;
            //on table number click event
            $('span.glyph').click(function() {
                $("#tblId").val($(this).data("tableid"));
                tableClickedId = $(this).data("tableid");
                //getting create order form
                $.ajax({
                    url: $(this).data('url'),
                    type: 'GET',
                    cache: false,
                    async: false,
                    success: function(result) {
                        $('.msmqpartial').html(result);
                    }
                });

                //getting all the times avialable for the table
                $("#freeTimePanel").css("display", "block");
                var params = { tableId: $(this).data("tableid"), date: new Date() };
                $.ajax({
                    url: "@Url.Action("GetAvialableTimes", "BookTable")",
                    contentType: "application/json",
                    data: JSON.stringify(params),
                    type: 'POST',
                    cache: false,
                    async: false,
                    success: function(result) {
                        $("#avialableTimeList").html(result);
                    }
                });

                //all avialable times for the table if the date changes
                $("#datePicker").val(new Date().dateFormat("Y.m.d"));
                $("#datePicker").blur(function() {
                    var params = { tableId: tableClickedId, date: $(this).val() };
                    $.ajax({
                        url: "@Url.Action("GetAvialableTimes", "BookTable")",
                        contentType: "application/json",
                        data: JSON.stringify(params),
                        type: 'POST',
                        cache: false,
                        success: function(result) {
                            $("#avialableTimeList").html(result);
                        }
                    });
                });
                return false;
            });

            //table click effect
            $(".glyph").click(function() {
                $(".glyph").css("color", "#444");
                $(this).css("color", "white");
            });

        });
    </script>
}
